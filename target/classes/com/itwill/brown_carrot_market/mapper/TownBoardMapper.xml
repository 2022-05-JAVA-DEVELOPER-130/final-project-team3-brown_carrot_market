<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itwill.brown_carrot_market.mapper.TownBoardMapper">
	<resultMap id="townBoradResultMap" type="com.itwill.brown_carrot_market.dto.TownBoard" >
		<result column="T_NO" property="t_no"/>
		<result column="T_TITLE" property="t_title"/>
		<result column="T_CONTENT" property="t_content"/>
		<result column="T_DATE" property="t_date"/>
		<result column="T_COUNT" property="t_count"/>
		<result column="T_ADDRESS_NAME" property="t_address_name"/>
		<result column="T_ADDRESS_LAT" property="t_address_lat"/>
		<result column="T_ADDRESS_LNG" property="t_address_lng"/>
		<association property="townCategory" javaType="com.itwill.brown_carrot_market.dto.TownCategory">
			<result column="T_CTGR_NO" property="t_ctgr_no"/>
			<result column="T_CTGR_NAME" property="t_ctgr_name"/>
		</association>
		<association property="userInfo" javaType="com.itwill.brown_carrot_market.dto.UserInfo">
			<result column="USER_ID" property="user_id"/>
			<result column="USER_PW" property="user_pw"/>
			<result column="USER_NAME" property="user_name"/>
			<result column="USER_EMAIL" property="user_email"/>
			<result column="USER_PHONE" property="user_phone"/>
			<result column="USER_FRESHNESS" property="user_freshness"/>
			<result column="USER_POINT" property="user_point"/>
			<result column="USER_PROFILE" property="user_profile"/>
		</association>
		<collection property="townImageList" javaType="java.util.List" ofType="com.itwill.brown_carrot_market.dto.TownImage" >
			<result column="T_IMG_NO" property="t_img_no"/>
			<result column="T_IMG_NAME" property="t_img_name"/>
			<result column="T_NO" property="t_no"/>
			
		</collection>
		
	</resultMap>
	 
	<!-- 동네게시판 글 등록 -->
	<!-- 
	<insert id="">
	insert into town_board(t_no, t_title, t_content, t_date, t_count, t_ctgr_no,t_address_name, t_address_lat,t_address_lng,user_id)
	values(TOWN_BOARD_T_NO_SEQ.nextval, '저 배고파요','기분전환 겸 염색하고 싶은데 추천할만한 곳 있을까요?',sysdate-6,10,1,
         (select a.ADDRESS_NAME from ADDRESS a where a.user_id='carrot1' and a.address_no=1), 
         (select a.ADDRESS_LAT from ADDRESS a where a.user_id='carrot1' and a.address_no=1),
         (select a.ADDRESS_LNG from ADDRESS a where a.user_id='carrot1' and a.address_no=1),
         'carrot1');
	</insert> 
	 -->
	<insert id="insertTownBoard" parameterType="com.itwill.brown_carrot_market.dto.TownBoard">
		<selectKey resultType="string" keyProperty="address_name" order="BEFORE">
			select a.ADDRESS_NAME from ADDRESS a where a.user_id=#{user_id} and a.address_no=#{address_no}
		</selectKey>
		<selectKey resultType="int" keyProperty="address_lat" order="BEFORE">
			select a.ADDRESS_LAT from ADDRESS a where a.user_id=#{user_id} and a.address_no=#{address_no}
		</selectKey>
		<selectKey resultType="int" keyProperty="address_lng" order="BEFORE">
			select a.ADDRESS_LNG from ADDRESS a where a.user_id=#{user_id} and a.address_no=#{address_no}
		</selectKey>
		insert into town_board(t_no, t_title, t_content, t_date, t_count, t_ctgr_no,t_address_name, t_address_lat,t_address_lng,user_id)
		values(TOWN_BOARD_T_NO_SEQ.nextval, #{t_title},#{t_content},sysdate,#{t_count},#{t_ctgr_no},#{address_name},#{address_lat},#{addresss_lng},#{user_id})
	</insert>  
	
	
	<!-- 비회원이 동네게시판 글 전체 조회.. -->
	<select id="selectNonMemberTownBoardList" resultMap="townBoradResultMap">
		select * from town_board tb 
		join town_img ti 
		on tb.t_no = ti.t_no
		join town_category tc
		on tc.t_ctgr_no = tb.t_ctgr_no
		order by tb.t_date desc
	</select>
	
	<!-- 비회원이 카테고리로 조건 검색(동네게시판 글 전체 조회) -->
	<select id="selectNonMemberCtgrTownBoardList" resultMap="townBoradResultMap">
	select * from town_board tb 
	join town_img ti 
	on tb.t_no = ti.t_no
	join town_category tc
	on tc.t_ctgr_no = tb.t_ctgr_no
	where tc.t_ctgr_no=#{t_ctgr_no}
	order by tb.t_date desc
	</select>
	
	<!-- 동네 게시판 글 전체 조회 (좌표 값에 따라 검색하기) -->
	<select id="selectTownBoardListCoordinate" parameterType="map" resultMap="townBoradResultMap" >
		select * from (select * from town_board tb 
join town_img ti 
on tb.t_no = ti.t_no
join town_category tc
on tc.t_ctgr_no = tb.t_ctgr_no
where tb.t_address_lat 
             between (select a.address_lat from address a where a.user_id=#{user_id} and a.address_no=#{address_no})-0.004504505*(select a.address_range from address a where a.user_id=#{user_id} and a.address_no=#{address_no})
                AND (select a.address_lat from address a where a.user_id=#{user_id} and a.address_no=#{address_no})+0.004504505*(select a.address_range from address a where a.user_id=#{user_id} and a.address_no=#{address_no})) tblist
        where tblist.t_address_lng
        between (select a.address_lng from address a where a.user_id=#{user_id} and a.address_no=#{address_no})-0.056344377*(select a.address_range from address a where a.user_id=#{user_id} and a.address_no=#{address_no})
            AND (select a.address_lng from address a where a.user_id=#{user_id} and a.address_no=#{address_no})+0.056344377*(select a.address_range from address a where a.user_id=#{user_id} and a.address_no=#{address_no})
		
	</select>
	
	
	<!-- 동네 게시판 글 전체 조회(좌표값에 따라 검색 + 카테고리로 검색) -->
	<select id="selectTownBoardCtgrListCoordinate" parameterType="map" resultMap="townBoradResultMap" >
		select * from (select * from(select * from town_board tb left outer join town_img ti on tb.t_no = ti.t_no
                            join town_category tc on tc.t_ctgr_no = tb.t_ctgr_no where tc.t_ctgr_no=#{t_ctgr_no}) aa
where aa.t_address_lat 
             between (select a.address_lat from address a where a.user_id=#{user_id} and a.address_no=#{address_no})-0.004504505*(select a.address_range from address a where a.user_id=#{user_id} and a.address_no=#{address_no})
                AND (select a.address_lat from address a where a.user_id=#{user_id} and a.address_no=#{address_no})+0.004504505*(select a.address_range from address a where a.user_id=#{user_id} and a.address_no=#{address_no})) tblist
        where tblist.t_address_lng
        between (select a.address_lng from address a where a.user_id=#{user_id} and a.address_no=#{address_no})-0.056344377*(select a.address_range from address a where a.user_id=#{user_id} and a.address_no=#{address_no})
            AND (select a.address_lng from address a where a.user_id=#{user_id} and a.address_no=#{address_no})+0.056344377*(select a.address_range from address a where a.user_id=#{user_id} and a.address_no=#{address_no})
		
	</select>
	
	<!-- 게시글 한개 찾기(글 번호로) -->
	<select id="selectTownBoardOne" parameterType="java.lang.Integer" resultType="java.lang.Integer">
		select * from town_board where t_no=#{t_no}
	</select>
	
	<!-- 게시글 한개 삭제 -->
	<delete id="deleteTownBoardOne" parameterType="java.lang.Integer">
		delete town_board where t_no=#{t_no}
	</delete>
	
	<!-- 게시글 한개 수정 -->
	<update id="updateTownBoardOne" parameterType="com.itwill.brown_carrot_market.dto.TownBoard">
		update town_board set t_title=#{t_title},t_content=#{t_content}, t_ctgr_no=#{t_ctgr_no} where t_no=#{t_no}
	</update>
	
	<!-- 게시물 조회수 증가 -->
	<update id="updateTownBoardCount" parameterType="java.lang.Integer">
		update town_board set t_count=t_count+1 where t_no=#{t_no}
	</update>
	
	<!-- 게시물의 공감수 구하기 -->
	<select id="selectTownBoardReacCount" parameterType="java.lang.Integer" resultType="java.lang.Integer">
		select count(*) from town_reaction where t_no=#{t_no}
	</select>
	<!-- 게시물의 공감 타입별 공감수 구하기 -->
	<select id="selectTownBoardReacTypeCount" parameterType="java.lang.Integer" resultType="java.lang.Integer">
		select count(*) from town_reaction where t_no=#{t_no} and t_reac_type=#{t_reac_type}
	</select>
	
	
</mapper>